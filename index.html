<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <title>–ú–∏—à–∫–∞-–ª–æ–º–∞—Ç–µ–ª—å –∏–∫–æ–Ω–æ–∫ üêª</title>
  <meta name="theme-color" content="#4b3c6e">

  <style>
    :root{
      --w:1179; /* —Ä–µ–∞–ª—å–Ω—ã–π –∫–∞–Ω–≤–∞—Å: iPhone 16 px */
      --h:2556;
      --bg:#4a3a6e;       /* —Ñ–æ–Ω –∫–∞–∫ –≤ Early Worm */
      --lane:#2b2833;     /* –±–∞–∑–æ–≤—ã–π –ø–æ–ª */
      --lane2:#30303a;    /* –≤—Ç–æ—Ä–∞—è –∫–ª–µ—Ç–∫–∞ –¥–ª—è —à–∞—Ö–º–∞—Ç–∫–∏ */
      --bush:#3BB34A;     /* –∫—É—Å—Ç—ã */
      --shadow:0 30px 120px rgba(0,0,0,.45);
      --cell:27;          /* —Ä–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ –Ω–∞ –∫–∞–Ω–≤–∞—Å–µ (—É–¥–æ–±–Ω–æ –¥–µ–ª–∏—Ç—Å—è) */
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial;color:#fff}
    .wrap{
      /* —á—Ç–æ–±—ã –ø–æ–ª–æ—Ç–Ω–æ 1179√ó2556 –≤–ª–µ–∑–∞–ª–æ –≤ –ª—é–±–æ–µ –æ–∫–Ω–æ, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ */
      position:fixed; inset:0; display:grid; place-items:center;
      background:var(--bg);
    }
    canvas{
      width:min(100vw, calc(100vh * (1179/2556)));
      height:calc(100vw * (2556/1179));
      max-height:100vh;
      max-width:100vw;
      box-shadow:var(--shadow);
      border-radius:28px;
      touch-action:none;   /* –≤–∞–∂–Ω–æ –¥–ª—è —Ç–∞—á–∞ –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
      background:#201a2f;
    }
    .hud{
      position:fixed; left:50%; top:14px; transform:translateX(-50%);
      display:flex; gap:10px; align-items:center; padding:8px 14px; border-radius:999px;
      background:#00000033; backdrop-filter: blur(6px); font-weight:700
    }
    .btn{background:#ffffff15; color:#fff; border:0; padding:10px 14px; border-radius:12px; font-weight:700}
  </style>
</head>
<body>
  <div class="hud">
    <div id="score">–°—á—ë—Ç: 0</div>
    <button class="btn" id="restart">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</button>
  </div>
  <div class="wrap">
    <canvas id="game" width="1179" height="2556"></canvas>
  </div>

<script>
(() => {
  const W = 1179, H = 2556;
  const CELL = 27;                 // —Å–µ—Ç–∫–∞ 27 px
  const COLS = Math.floor(W / CELL);
  const ROWS = Math.floor(H / CELL);

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // ----- –≥–µ–æ–º–µ—Ç—Ä–∏—è —É—Ä–æ–≤–Ω—è (–≤ —Å—Ç–∏–ª–µ Early Worm) -----
  const playRect = { x: CELL*2, y: CELL*4, w: W - CELL*4, h: H - CELL*8, r: 60 }; // –±–æ–ª—å—à–æ–µ L-–æ–±—Ä–∞–∑–Ω–æ–µ –Ω–µ –¥–µ–ª–∞–µ–º ‚Äî –±–µ—Ä—ë–º –æ–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
  function roundRectPath({x,y,w,h,r}){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  // —Ä–∏—Å—É–µ–º —à–∞—Ö–º–∞—Ç–Ω—ã–π –ø–æ–ª
  function drawFloor(){
    roundRectPath(playRect);
    ctx.save();
    ctx.clip();
    const s = CELL;
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const xx = c*s, yy = r*s;
        if(xx<playRect.x || xx>playRect.x+playRect.w-s || yy<playRect.y || yy>playRect.y+playRect.h-s) continue;
        ctx.fillStyle = ((r+c)%2===0) ? '#2b2833' : '#34323d';
        ctx.fillRect(xx, yy, s, s);
      }
    }
    ctx.restore();
  }

  // —Ä–∏—Å—É–µ–º ¬´–∫—É—Å—Ç—ã¬ª –ø–æ –ø–µ—Ä–∏–º–µ—Ç—Ä—É
  function drawBushBorder(){
    const {x,y,w,h,r}=playRect;
    // —Ç–æ–ª—Å—Ç–∞—è –∑–µ–ª—ë–Ω–∞—è ¬´—Ä–∞–º–∫–∞¬ª
    ctx.save();
    roundRectPath({x:x-26, y:y-26, w:w+52, h:h+52, r:r+26});
    ctx.clip('evenodd');
    ctx.fillStyle='#3EB84F';
    roundRectPath({x:x-18, y:y-18, w:w+36, h:h+36, r:r+18}); ctx.fill();
    // –∑—É–±—á–∏–∫–∏-–ª–∏—Å—Ç—å—è (–ø—Ä–æ—Å—Ç—ã–µ –¥—É–≥–∏)
    ctx.strokeStyle='#2f8f39'; ctx.lineWidth=18;
    for(let i=0;i<40;i++){
      const t = i/40;
      const px = x + r + (w-2*r)*t;
      ctx.beginPath(); ctx.arc(px, y-6, 18, 0, Math.PI*2); ctx.stroke();
      ctx.beginPath(); ctx.arc(px, y+h+6, 18, 0, Math.PI*2); ctx.stroke();
    }
    for(let i=0;i<60;i++){
      const t = i/60;
      const py = y + r + (h-2*r)*t;
      ctx.beginPath(); ctx.arc(x-6, py, 18, 0, Math.PI*2); ctx.stroke();
      ctx.beginPath(); ctx.arc(x+w+6, py, 18, 0, Math.PI*2); ctx.stroke();
    }
    ctx.restore();
  }

  // ----- —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–æ–π (–∫—É—Å—Ç—ã = –≤–Ω–µ playRect) -----
  function insidePlay(x, y){
    // –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–∫—É –≤ —Å–∫—Ä—É–≥–ª—ë–Ω–Ω–æ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–µ: —Ç–æ–≥–¥–∞ –æ–±—Ä–µ–∑–∞–µ–º —É–≥–ª—ã –∫—Ä—É–≥–∞–º–∏
    const {x:rx,y:ry,w,h,r} = playRect;
    // –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö –∑–æ–Ω–∞—Ö
    if (x>=rx+r && x<=rx+w-r && y>=ry && y<=ry+h) return true;
    if (x>=rx && x<=rx+w && y>=ry+r && y<=ry+h-r) return true;
    // –≤ —É–≥–ª–æ–≤—ã—Ö —á–µ—Ç–≤–µ—Ä—Ç—è—Ö
    const inCirc = (cx,cy) => (x-cx)*(x-cx)+(y-cy)*(y-cy) <= r*r;
    if (x<rx+r && y<ry+r && inCirc(rx+r, ry+r)) return true;             // TL
    if (x>rx+w-r && y<ry+r && inCirc(rx+w-r, ry+r)) return true;         // TR
    if (x<rx+r && y>ry+h-r && inCirc(rx+r, ry+h-r)) return true;         // BL
    if (x>rx+w-r && y>ry+h-r && inCirc(rx+w-r, ry+h-r)) return true;     // BR
    return false;
  }

  // ----- –∏–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ ¬´–∑–º–µ–π–∫–∏¬ª, —Ç–æ–ª—å–∫–æ –≥–æ–ª–æ–≤–∞ ‚Äî –º–∏—à–∫–∞ -----
  const dir = {x:1, y:0};                 // —Ç–µ–∫—É—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  const speed = 1;                         // –∫–ª–µ—Ç–æ–∫ –∑–∞ —Ç–∏–∫
  let snake = [];                          // –º–∞—Å—Å–∏–≤ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ {x,y}
  let grow = 6;                            // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –¥–ª–∏–Ω–∞
  let icons = [];                          // ¬´–∏–∫–æ–Ω–∫–∏ A¬ª –¥–ª—è –ª–æ–º–∞–Ω–∏—è
  let score = 0;
  const scoreEl = document.getElementById('score');

  function gridSnap(v){ return Math.round(v / CELL) * CELL; }

  function reset(){
    snake = [];
    const startX = gridSnap(playRect.x + playRect.w/2);
    const startY = gridSnap(playRect.y + playRect.h/2);
    for(let i=0;i<8;i++) snake.push({x:startX - i*CELL, y:startY});
    dir.x = 1; dir.y = 0;
    grow = 6;
    score = 0; scoreEl.textContent = '–°—á—ë—Ç: 0';
    spawnIcons(7);
    running = true;
  }

  function spawnIcons(n){
    icons = [];
    for(let i=0;i<n;i++){
      let p;
      do{
        p = {
          x: gridSnap(playRect.x + CELL + Math.random()*(playRect.w-2*CELL)),
          y: gridSnap(playRect.y + CELL + Math.random()*(playRect.h-2*CELL))
        };
      }while(collidesWithSnake(p) || !insidePlay(p.x, p.y));
      icons.push(p);
    }
  }

  function collidesWithSnake(p){
    return snake.some(s => s.x===p.x && s.y===p.y);
  }

  // ----- —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–π—Ç–æ–≤ -----
  function drawBearHead(x,y){
    // —Ç–µ–ª–æ-–∫—Ä—É–∂–æ–∫
    ctx.save();
    ctx.translate(x+CELL/2, y+CELL/2);
    const R = CELL*0.65;
    // —Ç–µ–Ω—å
    ctx.fillStyle = 'rgba(0,0,0,.25)';
    ctx.beginPath(); ctx.ellipse(4,6,R*0.95,R*0.7,0,0,Math.PI*2); ctx.fill();
    // –º–æ—Ä–¥–∞
    ctx.fillStyle='#ffffff';
    ctx.beginPath(); ctx.arc(0,0,R,0,Math.PI*2); ctx.fill();
    // —É—à–∫–∏
    ctx.beginPath(); ctx.arc(-R*.55,-R*.55,R*.28,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( R*.55,-R*.55,R*.28,0,Math.PI*2); ctx.fill();
    // –Ω–æ—Å
    ctx.fillStyle='#1f1f1f';
    ctx.beginPath(); ctx.ellipse(0,R*0.12,R*0.28,R*0.22,0,0,Math.PI*2); ctx.fill();
    // –æ—á–∫–∏
    ctx.strokeStyle='#111'; ctx.lineWidth=4;
    ctx.strokeRect(-R*0.62,-R*0.2,R*0.48,R*0.32);
    ctx.strokeRect( R*0.14,-R*0.2,R*0.48,R*0.32);
    ctx.beginPath(); ctx.moveTo(-R*0.14,-R*0.06); ctx.lineTo(R*0.14,-R*0.06); ctx.stroke();
    ctx.restore();
  }
  function drawIconA(x,y){
    const s = CELL*0.8;
    ctx.save();
    ctx.translate(x+CELL/2, y+CELL/2);
    ctx.fillStyle='#fff';
    ctx.beginPath();
    // –±—É–∫–≤–∞ ¬´–ê¬ª (–±–µ–ª–∞—è)
    ctx.moveTo(-s*0.45, s*0.5);
    ctx.lineTo(0, -s*0.5);
    ctx.lineTo(s*0.45, s*0.5);
    ctx.lineTo(s*0.2, s*0.5);
    ctx.lineTo(s*0.08, s*0.2);
    ctx.lineTo(-s*0.08, s*0.2);
    ctx.lineTo(-s*0.2, s*0.5);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }
  function drawSnake(){
    // —Ö–≤–æ—Å—Ç ‚Äî –º—è–≥–∫–∏–µ –∫—Ä—É–≥–ª—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã
    for(let i=1;i<snake.length;i++){
      const s = snake[i];
      ctx.fillStyle = '#efeef6';
      ctx.beginPath();
      ctx.arc(s.x+CELL/2, s.y+CELL/2, CELL*0.4*(1-i/snake.length*0.6), 0, Math.PI*2); ctx.fill();
    }
    // –≥–æ–ª–æ–≤–∞-–º–∏—à–∫–∞
    const head = snake[0];
    drawBearHead(head.x, head.y);
  }

  // ----- —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -----
  let touchStart = null;
  function setDirFromDelta(dx,dy){
    if(Math.abs(dx) > Math.abs(dy)){
      if(dx>8 && dir.x!==-1){ dir.x=1; dir.y=0; }
      if(dx<-8 && dir.x!== 1){ dir.x=-1; dir.y=0; }
    }else{
      if(dy>8 && dir.y!==-1){ dir.x=0; dir.y=1; }
      if(dy<-8 && dir.y!== 1){ dir.x=0; dir.y=-1; }
    }
  }
  canvas.addEventListener('touchstart', e=>{
    const t = e.changedTouches[0];
    touchStart = {x:t.clientX, y:t.clientY};
    e.preventDefault();
  }, {passive:false});
  canvas.addEventListener('touchmove', e=>{
    if(!touchStart) return;
    const t = e.changedTouches[0];
    setDirFromDelta(t.clientX - touchStart.x, t.clientY - touchStart.y);
    // –ø–∞–ª–µ—Ü –Ω–µ –æ—Ç—Ä—ã–≤–∞–µ–º ‚Äî —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    e.preventDefault();
  }, {passive:false});
  canvas.addEventListener('touchend', ()=>{ touchStart=null });

  // –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
  document.addEventListener('keydown', e=>{
    if(e.key==='ArrowLeft'  && dir.x!==1 ){dir.x=-1;dir.y=0}
    if(e.key==='ArrowRight' && dir.x!==-1){dir.x=1; dir.y=0}
    if(e.key==='ArrowUp'    && dir.y!==1 ){dir.x=0; dir.y=-1}
    if(e.key==='ArrowDown'  && dir.y!==-1){dir.x=0; dir.y=1}
  });

  // ----- –ø–µ—Ç–ª—è -----
  let tick=0, running=true;
  function step(){
    if(!running) return;
    requestAnimationFrame(step);

    // 60fps -> –¥–≤–∏–≥–∞–µ–º –∫–∞–∂–¥—ã–µ N –∫–∞–¥—Ä–æ–≤
    if((++tick)%6!==0) return;

    // –Ω–æ–≤–∞—è –≥–æ–ª–æ–≤–∞
    const head = {...snake[0]};
    head.x += dir.x*CELL*speed;
    head.y += dir.y*CELL*speed;

    // —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å–æ —Å—Ç–µ–Ω–æ–π/–∫—É—Å—Ç–∞–º–∏
    if(!insidePlay(head.x+CELL/2, head.y+CELL/2)){
      gameOver(); return;
    }
    // —Å–∞–º —Å–µ–±—è
    if(snake.slice(0, -1).some(s => s.x===head.x && s.y===head.y)){
      gameOver(); return;
    }

    snake.unshift(head);
    if(grow>0) { grow--; } else { snake.pop(); }

    // –∏–∫–æ–Ω–∫–∏
    for(let i=0;i<icons.length;i++){
      if(icons[i].x===head.x && icons[i].y===head.y){
        // ¬´—Å–ª–æ–º–∞–ª–∏¬ª –∏–∫–æ–Ω–∫—É
        icons.splice(i,1);
        score++; grow+=2;
        scoreEl.textContent='–°—á—ë—Ç: '+score;
        break;
      }
    }
    if(icons.length===0) spawnIcons(7);

    // ---- –†–ï–ù–î–ï–† ----
    ctx.clearRect(0,0,W,H);
    drawFloor();
    drawBushBorder();

    // –∏–∫–æ–Ω–∫–∏
    icons.forEach(p=> drawIconA(p.x, p.y));

    // –∑–º–µ–π–∫–∞/–º–∏—à–∫–∞
    drawSnake();
  }

  function gameOver(){
    running=false;
    // –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
    ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#fff'; ctx.font='bold 72px system-ui, -apple-system';
    ctx.textAlign='center';
    ctx.fillText('–í—ã –≤—Ä–µ–∑–∞–ª–∏—Å—å –≤ –∫—É—Å—Ç—ã üòÖ', W/2, H/2 - 40);
    ctx.font='bold 48px system-ui';
    ctx.fillText('–ù–∞–∂–º–∏—Ç–µ ¬´–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫¬ª', W/2, H/2 + 20);
  }

  document.getElementById('restart').onclick = ()=>{ reset(); step(); };

  // —Å—Ç–∞—Ä—Ç
  reset();
  step();
})();
</script>
</body>
</html>
